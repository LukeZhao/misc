<!DOCTYPE HTML>
<html>
<body>
    <button onclick="doPublish()">Publish</button><br />
    <button onclick="dounPublish()">unPublish</button><br />
    <div id="id_status"></div><br />
    <script src="https://static.opentok.com/v2/js/opentok.js" charset="utf-8"></script>
    <script charset="utf-8">
        var apiKey = '45139172';
        var sessionId = '2_MX40NTEzOTE3Mn5-MTQ4NDE3MjY2NjkzOH5wNmZnZEZ1T1pneGVxY24zcjdvd2FyZkh-fg';
        var token = 'T1==cGFydG5lcl9pZD00NTEzOTE3MiZzaWc9ZmJlNGQzYTJkYmM4MGQ5MmUzOWNlMzI0NWQ5ZTkxYmIyYzBkMzJkZDpub25jZT05MjE2MCZjcmVhdGVfdGltZT0xNDg0MTcyNjY2JnJvbGU9cHVibGlzaGVyJnNlc3Npb25faWQ9Ml9NWDQwTlRFek9URTNNbjUtTVRRNE5ERTNNalkyTmprek9INXdObVpuWkVaMVQxcG5lR1Z4WTI0emNqZHZkMkZ5WmtoLWZn';
        var session = null;
        var publisher = OT.initPublisher('publisher', {
            insertMode: 'append',
            width: '250px',
            height: '150px'
        });
        var subscriber = null;
        var subStream = null;
        var endSession = false;

        function doPublish()
        {
            try{
                session.publish(publisher);
            }catch(err)
            {
                console.log("doPublish: ", err.code, err.message);
            }
        }

        function dounPublish()
        {
            try {
                session.unpublish(publisher);
            } catch (err) {
                console.log("dounPublish: ", err.code, err.message);
            }
        }

        var isInPubStream = false;
        function publish() {
            if (isInPubStream)
                return;
            isInPubStream = true;
            var found = false;
            try {
                session.streams.forEach(function (st) {
                    if (st.destroyed)
                        return;
                    if (st.connection.connectionId != session.connection.connectionId || found)
                        return;
                    found = true;
                });
                if (!found) {
                    x = document.getElementsByClassName("OT_mirrored OT_root OT_publisher OT_fit-mode-cover");
                    if (x.length == 0) {
                        publisher = OT.initPublisher('publisher', {
                            insertMode: 'append',
                            width: '250px',
                            height: '150px'
                        });
                    }
                    else {
                        try {
                            session.unpublish(publisher);
                        }
                        catch (err) { }
                    }
                    try {
                        session.publish(publisher);
                    }
                    catch (err) {
                        console.log('Error publishing: ', err.code, err.message);
                    }
                }
            } catch (err) { }

            isInPubStream = false;
        }

        function connect_again()
        {
            if (session.isConnected())
            {
                publish();
                return;
            }

            session.connect(token, function (error) {
                if (!error) {
                    publish();
                } else {
                    console.log('connect_again - error: ', error.code, error.message);
                }
            });
        }

        var isInSubStream = false;
        function sub_stream() {
            if (isInSubStream)
                return;
            isInSubStream = true;
            var found = false;
            try {
                session.streams.forEach(function (st) {
                    if (st.destroyed)
                        return;
                    if (st.connection.connectionId == session.connection.connectionId || found)
                        return;
                    if (subscriber != null) {
                        x = document.getElementsByClassName("OT_root OT_subscriber OT_fit-mode-cover");
                        if (x.length > 0) {
                            session.subscribe(st, subscriber);
                            found = true;
                            return;
                        }
                    }
                    subscriber = session.subscribe(st, 'subscriber', {
                        insertMode: 'append',
                        width: '500px',
                        height: '350px'
                    });
                    found = true;
                });
            } catch (err) { }
            isInSubStream = false;
            if (!found)
            {
                  session.signal(
                      {
                          data: "hello",
                          type: "publish"
                      },
                      function (error) {
                          if (error) {
                              console.log("signal send - error: ", error.name, error.message);
                          } else {
                              console.log("signal send - success.");
                          }
                      }
                 );
                 setTimeout(sub_stream, 3000);
            }
        }

        function request_publish()
        {
            if (endSession)
                return;
            setTimeout(sub_stream, 2000);
        }

        // Create a new session and connect to the sesssion id.
        function connect_session() {
            if (endSession)
                return;
            try {
                if (session != null)
                {
                    connect_again();
                    return;
                }

            } catch (err) { }
            console.log('Step 4');
            try {
                session = OT.initSession(apiKey, sessionId);
            } catch (err) {
                console.log('There was an error creating a session: ', err.code, err.message);
                setTimeout(connect_session, 3000);
                return;
            }
            console.log('Step 5');

            session.on("signal:publish", function (event) {
                if (event.from.id == session.connection.connectionId)
                    return;
                console.log("Signal for publish:  " + event.from.id + " session state: " + session.currentState);
                try {
                    console.log('Pulishing stream...');
                    publish();
                } catch (err) {
                    console.log('There was an error publishing a session: ', err.code, err.message);
                }
                // Process the event.data property, if there is any data.
            });

            session.on("connectionCreated", function (event) {
                if (event.connection.connectionId == session.connection.connectionId)
                    console.log("event connectionCreated:  self = ", event.connection.connectionId);
                else
                    console.log("event connectionCreated:  other = ", event.connection.connectionId);
            });

            session.on("sessionConnected", function (event) {
                if (event.connection.connectionId == session.connection.connectionId)
                    console.log("event sessionConnected:  self = ", event.connection.connectionId);
                else
                    console.log("event sessionConnected:  other = ", event.connection.connectionId);
            });

            session.on("exception", function (event) {
                console.log("event sessionConnected: ", event.code, event.title, event.message, event.target);
            });

            session.on('streamDestroyed', function (event) {
                if (event.stream.connection.connectionId == session.connection.connectionId)
                {
                    console.log("event streamDestroyed:  self = ", event.stream.connection.connectionId, event.reason);
                }

                else
                {
                    console.log("event streamDestroyed:  other = ", event.stream.connection.connectionId, event.reason);
                }
            });

            session.on('streamCreated', function (event) {
                if (event.stream.connection.connectionId == session.connection.connectionId)
                {
                    console.log("event streamCreated:  self = ", event.stream.connection.connectionId, event.reason);
                }
                else {
                    console.log("event streamCreated:  other = ", event.stream.connection.connectionId, event.reason);
                    sub_stream();
                }
            });
            console.log('Step 6');
            session.on('sessionDisconnected', function (event) {
                console.log("event sessionDisconnected: ", event.reason);
                session = null;
            });
            session.on('connectionDestroyed', function (event) {
                if (event.connection.connectionId == session.connection.connectionId)
                    console.log("event connectionDestroyed:  self = ", event.connection.connectionId, event.reason);
                else
                    console.log("event connectionDestroyed:  other = ", event.connection.connectionId, event.reason);
            });

            console.log('Step 7');
            // Connect to the session
            session.connect(token, function (error) {
                // If the connection is successful, initialize a publisher and publish to the session
                console.log('Step 9');
                if (!error) {
                    publish();
                } else {
                    console.log('Error connecting to the session: ', error.code, error.message);
                }
            });
            console.log('Step 8');
        }

        connect_session();

        var prevStats;
        var intervalId = window.setInterval(function () {
            if (endSession) {
                window.clearInterval(intervalId);
                return;
            }
            if (session == null) {
                console.log("Interval - session is null");
                connect_session();
                return;
            }
            if (session.is('connecting'))
            {
                console.log("Interval - session is connecting");
                return;
            }

            if (subscriber == null) {
                console.log("Interval - subscriber is null");
                sub_stream();
                return;
            }
            subscriber.getStats(function (error, stats) {
                if (error) {
                    console.log("Interval - getStats error: ", error.message);
                    sub_stream();
                    return;
                }
                if (prevStats) {
                    var videoBitRate = 8 * (stats.video.bytesReceived - prevStats.video.bytesReceived);
                    var audioBitRate = 8 * (stats.audio.bytesReceived - prevStats.audio.bytesReceived);
                    document.getElementById("id_status").innerHTML = "<P>Video: ".concat(videoBitRate.toString(), ", Audio: ", audioBitRate.toString(), "</P>");
                }
                prevStats = stats;
            });
        }, 10000);
    </script>
</body>
</html>